<!doctype html>
<html lang="pt-br">
<head>
    {% load static %}
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GIRO DNC - Gestão Financeira</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
 <link rel="stylesheet" href="{% static 'paginas/css/admin.css' %}">
  <link rel="stylesheet" href="{% static 'paginas/css/style.css' %}">
 
  <style>
    /* Design Minimalista Giro */

  </style>
</head>

<body>
  <header class="gd-topbar">
    <div class="gd-logo-container">
      <a href="{% url 'paginas:home' %}">
        <img src="{% static 'paginas/img/Girologo.jpg' %}" alt="Logo Giro" class="gd-logo">
      </a>
    </div>
    <div class="gd-topbar-content">
      <span class="gd-pill">GIRO DNC</span>
    </div>
  </header>

  <!-- Menu Sanduíche -->
  <div class="sidebar-item">
    <button id="sidebar-toggle" class="menu-sanduiche">
      <i class="bi bi-list"></i>
    </button>
  </div>

  <div class="gd-layout d-flex">
    <!-- Sidebar Padronizado -->
    {% with sidebar_section='admin' sidebar_active='despesas_admin' %}
      {% include 'includes/sidebar.html' %}
    {% endwith %}

    <main class="gd-main">
      <div class="conteudo">
        
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <h1 class="titulo-principal mb-1">Gestão Financeira</h1>
            <p class="text-muted mb-0" style="font-size: 0.9rem;">Controle de entradas e despesas</p>
          </div>
          <a href="{% url 'paginas:exportar_despesas_admin_excel' %}" class="btn btn-minimal">
            <i class="bi bi-download me-2"></i>Exportar
          </a>
        </div>

        <!-- Cards de Resumo -->
        <div class="row g-3 mb-4">
          <div class="col-md-3">
            <div class="stat-card-minimal">
              <div class="stat-label">Entradas</div>
              <div class="stat-value text-success">R$ 0,00</div>
              <small class="text-muted">Total recebido</small>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card-minimal">
              <div class="stat-label">Despesas</div>
              <div class="stat-value text-danger">R$ {{ total_despesas|floatformat:2 }}</div>
              <small class="text-muted">Total gasto</small>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card-minimal">
              <div class="stat-label">Saldo</div>
              <div class="stat-value">R$ -{{ total_despesas|floatformat:2 }}</div>
              <small class="text-muted">Entradas - Despesas</small>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card-minimal">
              <div class="stat-label">Pendente</div>
              <div class="stat-value" style="color: #f59e0b;">R$ {{ total_pendente|floatformat:2 }}</div>
              <small class="text-muted">A pagar</small>
            </div>
          </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs-minimal" id="financeTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="despesas-tab" data-bs-toggle="tab" data-bs-target="#despesas" type="button">
              Despesas
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="entradas-tab" data-bs-toggle="tab" data-bs-target="#entradas" type="button">
              Entradas
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="graficos-tab" data-bs-toggle="tab" data-bs-target="#graficos" type="button">
              Gráficos
            </button>
          </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="financeTabsContent">
          
          <!-- DESPESAS TAB -->
          <div class="tab-pane fade show active" id="despesas" role="tabpanel">
            
            <!-- Filtros -->
            <div class="filter-bar">
              <form method="GET" class="row g-3">
                <div class="col-md-3">
                  <input type="month" class="form-control form-control-minimal" name="mes" value="{{ mes_filtro }}" placeholder="Mês">
                </div>
                <div class="col-md-3">
                  <select class="form-select form-select-minimal" name="categoria">
                    <option value="">Todas categorias</option>
                    {% for value, label in categorias %}
                      <option value="{{ value }}" {% if categoria_filtro == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-2">
                  <select class="form-select form-select-minimal" name="status">
                    <option value="">Todos status</option>
                    {% for value, label in status_choices %}
                      <option value="{{ value }}" {% if status_filtro == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-2">
                  <button type="submit" class="btn btn-minimal w-100">Filtrar</button>
                </div>
                <div class="col-md-2">
                  <a href="{% url 'paginas:criar_despesa_admin' %}" class="btn btn-minimal-primary w-100">
                    <i class="bi bi-plus"></i> Nova Despesa
                  </a>
                </div>
              </form>
            </div>

            <!-- Tabela de Despesas -->
            {% if despesas %}
            <div class="table-minimal">
              <table class="table mb-0">
                <thead>
                  <tr>
                    <th>Nome</th>
                    <th>Categoria</th>
                    <th class="text-end">Valor</th>
                    <th class="text-end">Pago</th>
                    <th>Vencimento</th>
                    <th>Status</th>
                    <th class="text-end">Ações</th>
                  </tr>
                </thead>
                <tbody>
                  {% for despesa in despesas %}
                  <tr>
                    <td>
                      <strong style="font-size: 0.9rem;">{{ despesa.nome|truncatewords:5 }}</strong>
                      {% if despesa.fornecedor %}
                        <br><small class="text-muted">{{ despesa.fornecedor|truncatewords:3 }}</small>
                      {% endif %}
                    </td>
                    <td><span class="badge-minimal" style="background-color: {{ despesa.get_categoria_color }}15; color: {{ despesa.get_categoria_color }}; border-color: {{ despesa.get_categoria_color }}30;">{{ despesa.categoria_display }}</span></td>
                    <td class="text-end"><strong>R$ {{ despesa.valor_total|floatformat:2 }}</strong></td>
                    <td class="text-end">
                      <small class="text-success">R$ {{ despesa.valor_pago|floatformat:2 }}</small>
                      <div class="progress mt-1" style="height: 4px;">
                        <div class="progress-bar bg-success" style="width: {{ despesa.percentual_pago }}%"></div>
                      </div>
                    </td>
                    <td>
                      <small>{{ despesa.data_vencimento|date:"d/m/Y" }}</small>
                      {% if despesa.esta_atrasado and despesa.status != 'PAGO' %}
                        <br><span class="badge-minimal badge-red">Atrasado</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if despesa.status == 'PAGO' %}
                        <span class="badge-minimal badge-green">Pago</span>
                      {% elif despesa.status == 'PENDENTE' %}
                        <span class="badge-minimal badge-yellow">Pendente</span>
                      {% elif despesa.status == 'ATRASADO' %}
                        <span class="badge-minimal badge-red">Atrasado</span>
                      {% elif despesa.status == 'PARCIAL' %}
                        <span class="badge-minimal badge-blue">Parcial</span>
                      {% else %}
                        <span class="badge-minimal badge-gray">{{ despesa.status_display }}</span>
                      {% endif %}
                    </td>
                    <td class="text-end">
                      <a href="{% url 'paginas:editar_despesa_admin' despesa.id %}" class="action-icon me-2">
                        <i class="bi bi-pencil"></i>
                      </a>
                      <button class="action-icon" onclick="confirmarExclusao('{{ despesa.nome }}', {{ despesa.id }}, 'despesa')">
                        <i class="bi bi-trash"></i>
                      </button>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <div class="empty-state">
              <div class="empty-state-icon"><i class="bi bi-inbox"></i></div>
              <h5>Nenhuma despesa encontrada</h5>
              <p class="text-muted">Comece criando sua primeira despesa</p>
              <a href="{% url 'paginas:criar_despesa_admin' %}" class="btn btn-minimal-primary mt-3">
                <i class="bi bi-plus me-2"></i>Nova Despesa
              </a>
            </div>
            {% endif %}
          </div>

          <!-- ENTRADAS TAB -->
          <div class="tab-pane fade" id="entradas" role="tabpanel">
            <div class="empty-state">
              <div class="empty-state-icon"><i class="bi bi-currency-dollar"></i></div>
              <h5>Entradas Financeiras</h5>
              <p class="text-muted">Registre suas receitas e entradas de dinheiro</p>
              <button class="btn btn-minimal-primary mt-3">
                <i class="bi bi-plus me-2"></i>Nova Entrada
              </button>
            </div>
          </div>

          <!-- GRÁFICOS TAB -->
          <div class="tab-pane fade" id="graficos" role="tabpanel">
            <div class="row g-3">
              <div class="col-md-8">
                <div class="chart-container-minimal">
                  <div class="chart-title">Despesas por Categoria</div>
                  <div style="position: relative; height: 350px;">
                    <canvas id="graficoCategorias"></canvas>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="chart-container-minimal">
                  <div class="chart-title">Status</div>
                  <canvas id="graficoStatus"></canvas>
                </div>
              </div>
            </div>
          </div>

        </div>

      </div>
    </main>
  </div>

  <!-- Modal de Exclusão -->
  <div class="modal fade" id="modalExcluir" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content" style="border-radius: 12px; border: 1px solid #e5e5e5;">
        <div class="modal-header" style="border-bottom: 1px solid #e5e5e5;">
          <h5 class="modal-title">Confirmar Exclusão</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Tem certeza que deseja excluir <strong id="nomeItem"></strong>?</p>
          <p class="text-muted mb-0"><small>Esta ação não pode ser desfeita.</small></p>
        </div>
        <div class="modal-footer" style="border-top: 1px solid #e5e5e5;">
          <button type="button" class="btn btn-minimal" data-bs-dismiss="modal">Cancelar</button>
          <form id="formExcluir" method="POST" style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-minimal-primary" style="background: #ef4444; border-color: #ef4444;">Excluir</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="{% static 'paginas/js/sidebar.js' %}"></script>
  
  <script>
    // Gráfico de Categorias
    const ctxCat = document.getElementById('graficoCategorias');
    if (ctxCat) {
      try {
        const labels = {{ categorias_labels|safe }};
        const valores = {{ categorias_valores|safe }};
        
        console.log('Labels:', labels);
        console.log('Valores:', valores);
        
        // Verificar se há dados
        if (labels && valores && labels.length > 0 && valores.length > 0) {
          new Chart(ctxCat, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Valor',
                data: valores,
                backgroundColor: '#000',
                borderRadius: 8,
                barThickness: 40,
                maxBarThickness: 50,
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  backgroundColor: 'rgba(0, 0, 0, 0.8)',
                  padding: 12,
                  titleFont: { size: 13, weight: 'normal' },
                  bodyFont: { size: 14, weight: 'bold' },
                  callbacks: {
                    label: (context) => 'R$ ' + context.parsed.y.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  grid: { 
                    color: '#e5e5e5',
                    drawBorder: false
                  },
                  border: {
                    display: false
                  },
                  ticks: {
                    font: { size: 11 },
                    color: '#666',
                    callback: (value) => 'R$ ' + value.toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 0 })
                  }
                },
                x: {
                  grid: { display: false },
                  border: { display: false },
                  ticks: {
                    font: { size: 11 },
                    color: '#666',
                    maxRotation: 45,
                    minRotation: 0
                  }
                }
              }
            }
          });
        } else {
          // Mostrar mensagem quando não há dados
          ctxCat.parentElement.innerHTML = '<div class="text-center text-muted p-5"><i class="bi bi-inbox" style="font-size: 3rem;"></i><br><h6 class="mt-3">Nenhuma despesa cadastrada</h6><p class="small">As despesas aparecerão aqui quando forem adicionadas</p></div>';
        }
      } catch (error) {
        console.error('Erro ao criar gráfico de categorias:', error);
        ctxCat.parentElement.innerHTML = '<div class="text-center text-danger p-4"><i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i><br><small>Erro ao carregar gráfico</small></div>';
      }
    }

    // Gráfico de Status
    const ctxStatus = document.getElementById('graficoStatus');
    if (ctxStatus) {
      try {
        const statusLabels = {{ status_labels|safe }};
        const statusValores = {{ status_valores|safe }};
        const statusCores = {{ status_cores|safe }};
        
        console.log('Status Labels:', statusLabels);
        console.log('Status Valores:', statusValores);
        
        if (statusValores && statusValores.some(v => v > 0)) {
          new Chart(ctxStatus, {
            type: 'doughnut',
            data: {
              labels: statusLabels,
              datasets: [{
                data: statusValores,
                backgroundColor: statusCores,
                borderWidth: 3,
                borderColor: '#fff',
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: {
                  position: 'bottom',
                  labels: {
                    padding: 15,
                    font: { size: 12 },
                    usePointStyle: true,
                    pointStyle: 'circle',
                    boxWidth: 8,
                    boxHeight: 8,
                  }
                },
                tooltip: {
                  backgroundColor: 'rgba(0, 0, 0, 0.8)',
                  padding: 12,
                  titleFont: { size: 13, weight: 'normal' },
                  bodyFont: { size: 14, weight: 'bold' },
                  callbacks: {
                    label: (context) => context.label + ': R$ ' + context.parsed.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
                  }
                }
              }
            }
          });
        } else {
          ctxStatus.parentElement.innerHTML = '<div class="text-center text-muted p-5"><i class="bi bi-inbox" style="font-size: 3rem;"></i><br><h6 class="mt-3">Nenhuma despesa cadastrada</h6></div>';
        }
      } catch (error) {
        console.error('Erro ao criar gráfico de status:', error);
        ctxStatus.parentElement.innerHTML = '<div class="text-center text-danger p-4"><i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i><br><small>Erro ao carregar gráfico</small></div>';
      }
    }

    // Função de Exclusão
    function confirmarExclusao(nome, id, tipo) {
      document.getElementById('nomeItem').textContent = nome;
      document.getElementById('formExcluir').action = `/despesas-admin/deletar/${id}/`;
      const modal = new bootstrap.Modal(document.getElementById('modalExcluir'));
      modal.show();
    }
  </script>
</body>
