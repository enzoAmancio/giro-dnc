<!doctype html>
<html lang="pt-br">
<head>
    {% load static %}
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GIRO DNC - Mensalidades</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <link rel="stylesheet" href="{% static 'paginas/css/style.css' %}">
</head>

<body>
  <header class="gd-topbar">
    <div class="gd-logo-container">
      <a href="{% url 'paginas:home' %}">
        <img src="{% static 'paginas/img/Girologo.jpg' %}" alt="Logo Giro" class="gd-logo">
      </a>
    </div>
    <div class="gd-topbar-content">
      <span class="gd-pill">GIRO DNC</span>
    </div>
  </header>

  <!-- Menu Sanduíche -->
  <div class="sidebar-item">
    <button id="sidebar-toggle" class="menu-sanduiche">
      <i class="bi bi-list"></i>
    </button>
  </div>

  <div class="gd-layout d-flex">
    {% with sidebar_section='financeiro' sidebar_active='financeiro_mensalidades' %}
      {% include 'includes/sidebar.html' %}
    {% endwith %}

    <main class="gd-main">
      <div class="conteudo">

        <nav aria-label="breadcrumb">
          <ol class="breadcrumb bg-transparent p-0 mb-2">
            <li class="breadcrumb-item active fw-semi">Financeiro</li>
            <li class="breadcrumb-item active fw-semi">Mensalidades</li>
          </ol>
        </nav>

        <h1 class="titulo-principal mb-4">Mensalidades</h1>

        {% if aluno %}
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="card border-0 shadow-sm">
              <div class="card-body text-center">
                <h6 class="text-muted mb-2">Total Pago</h6>
                <h3 class="text-success mb-0">R$ {{ total_pago|floatformat:2 }}</h3>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card border-0 shadow-sm">
              <div class="card-body text-center">
                <h6 class="text-muted mb-2">Total Pendente</h6>
                <h3 class="text-warning mb-0">R$ {{ total_pendente|floatformat:2 }}</h3>
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        {% if mensalidades %}
          {% for mensalidade in mensalidades %}
          <div class="card border-0 shadow-sm card-pagamento mb-3">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="titulo-detalhes mb-0">{{ mensalidade.mes_referencia|date:"F/Y" }}</h5>
                <span class="badge 
                  {% if mensalidade.status == 'PAGO' %}bg-success
                  {% elif mensalidade.status == 'ATRASADO' %}bg-danger
                  {% elif mensalidade.status == 'PENDENTE' %}bg-warning text-dark
                  {% else %}bg-secondary{% endif %}">
                  {{ mensalidade.get_status_display }}
                </span>
              </div>

              <div class="row mb-4">
                <div class="col-md-6">
                  <ul class="list-unstyled mb-0">
                    <li><strong>Aluno:</strong> {{ mensalidade.aluno.usuario.get_full_name }}</li>
                    <li><strong>Referência:</strong> Mensalidade {{ mensalidade.mes_referencia|date:"m/Y" }}</li>
                    {% if mensalidade.valor_desconto > 0 %}
                    <li><strong>Desconto:</strong> R$ {{ mensalidade.valor_desconto|floatformat:2 }}</li>
                    {% endif %}
                    {% if mensalidade.data_pagamento %}
                    <li><strong>Pago em:</strong> {{ mensalidade.data_pagamento|date:"d/m/Y" }}</li>
                    {% endif %}
                  </ul>
                </div>
                <div class="col-md-6 text-md-end">
                  {% if mensalidade.valor_desconto > 0 %}
                  <p class="mb-1 text-muted"><s>R$ {{ mensalidade.valor|floatformat:2 }}</s></p>
                  {% endif %}
                  <p class="mb-1 fs-4 fw-bold text-dark">R$ {{ mensalidade.valor_final|floatformat:2 }}</p>
                  <p class="text-muted mb-0">
                    Vencimento: {{ mensalidade.data_vencimento|date:"d/m/Y" }}
                    {% if mensalidade.esta_atrasada %}
                    <br><small class="text-danger fw-bold">
                      <i class="bi bi-exclamation-triangle"></i> 
                      Atrasado há {{ mensalidade.dias_em_atraso }} dia{{ mensalidade.dias_em_atraso|pluralize }}
                    </small>
                    {% endif %}
                  </p>
                </div>
              </div>

              {% if mensalidade.status != 'PAGO' %}
              <div class="alert alert-warning d-flex align-items-center gap-2 py-2 px-3 mb-3">
                <i class="bi bi-info-circle"></i>
                Antes de realizar o pagamento, certifique-se de que o nome presente no boleto pertença à Giro DNC.
              </div>

              <div class="d-flex flex-wrap gap-3 mt-3">

                <!-- Botão que ativa o Brick -->
                <button 
                  id="btn-pagar-{{ mensalidade.id }}" 
                  class="btn btn-pagar shadow-sm px-4 py-2"
                  onclick="abrirPagamento({{ mensalidade.id }})"
                >
                  <i class="bi bi-credit-card me-1"></i> Realizar pagamento
                </button>

                <button class="btn btn-boleto shadow-sm px-4 py-2" onclick="alert('Funcionalidade em desenvolvimento')">
                  <i class="bi bi-printer me-1"></i> Imprimir boleto
                </button>
              </div>
              {% endif %}

              {% if mensalidade.observacoes %}
              <div class="mt-3">
                <small class="text-muted"><strong>Observações:</strong> {{ mensalidade.observacoes }}</small>
              </div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="card border-0 shadow-sm">
            <div class="card-body text-center py-5">
              <i class="bi bi-inbox" style="font-size: 3rem; color: #cbd5e1;"></i>
              <h5 class="text-muted mt-3">Nenhuma mensalidade encontrada</h5>
              <p class="text-muted mb-0">Não há registros de mensalidades no momento.</p>
            </div>
          </div>
        {% endif %}

        <!-- Container único para o Brick -->
        <div id="payment_container" class="mt-5"></div>
        <div id="statusScreenBrick_container" class="mt-3"></div>

      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{% static 'paginas/js/script.js' %}"></script>
  <script src="https://sdk.mercadopago.com/js/v2"></script>

  <script>
    let brickInstance = null;

    function abrirPagamento(mensalidadeId) {
      console.log('=== ABRIR PAGAMENTO ===');
      console.log('Mensalidade ID:', mensalidadeId);
      
      // Mostrar loading
      const container = document.getElementById('payment_container');
      container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div><p class="mt-3">Carregando forma de pagamento...</p></div>';
      container.scrollIntoView({ behavior: 'smooth', block: 'center' });

      const url = `/financeiro/mensalidade/${mensalidadeId}/pagar/`;
      console.log('URL da requisição:', url);

      // Fazer requisição para criar preferência
      fetch(url, {
        method: 'GET',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/json'
        }
      })
      .then(response => {
        console.log('Response status:', response.status);
        console.log('Response ok:', response.ok);
        return response.json();
      })
      .then(data => {
        console.log('Dados recebidos:', data);
        
        if (data.error) {
          console.error('Erro nos dados:', data.error);
          container.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
          return;
        }

        // Limpar brick anterior se existir
        if (brickInstance) {
          console.log('Desmontando brick anterior');
          brickInstance.unmount();
        }

        console.log('Criando MercadoPago com chave:', data.public_key);
        
        // Limpar container antes de criar o brick
        container.innerHTML = '';
        
        // Criar Payment Brick
        const mp = new MercadoPago(data.public_key);
        const bricksBuilder = mp.bricks();
        
        console.log('Criando Payment Brick com amount:', data.amount);
        
        bricksBuilder.create('payment', 'payment_container', {
          initialization: {
            amount: parseFloat(data.amount),
          },
          callbacks: {
            onReady: () => {
              console.log('Payment Brick pronto!');
            },
            onSubmit: ({ selectedPaymentMethod, formData }) => {
              console.log('Processando pagamento:', selectedPaymentMethod, formData);
              
              return fetch('/financeiro/processar-pagamento/', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                  ...formData,
                  mensalidade_id: mensalidadeId
                })
              })
              .then(response => response.json())
              .then(result => {
                console.log('Resultado do pagamento:', result);
                if (result.error) {
                  throw new Error(result.error);
                }
                // Redirecionar para página de sucesso ou mostrar status
                window.location.reload();
              })
              .catch(error => {
                console.error('Erro ao processar:', error);
                alert('Erro ao processar pagamento: ' + error.message);
              });
            },
            onError: (error) => {
              console.error('Erro no Payment Brick:', error);
            }
          },
          customization: {
            paymentMethods: {
              creditCard: 'all',
              debitCard: 'all',
              ticket: 'all',
              bankTransfer: 'all'
            }
          }
        }).then(brick => {
          console.log('Payment Brick criado com sucesso!');
          brickInstance = brick;
        }).catch(error => {
          console.error('Erro ao criar Payment Brick:', error);
          container.innerHTML = '<div class="alert alert-danger">Erro ao carregar forma de pagamento. Tente novamente.</div>';
        });
      })
      .catch(error => {
        console.error('Erro na requisição:', error);
        container.innerHTML = '<div class="alert alert-danger">Erro ao processar pagamento. Verifique sua conexão e tente novamente.</div>';
      });
    }
  </script>

</body>
</html>
